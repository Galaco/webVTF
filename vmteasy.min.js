function VTFReader(e){this.buffer=e,this.Char=function(e,t){var i=this.Read(e,t,Int8Array);ret="";for(var r=0;t>r;r++)ret+=String.fromCharCode(i[r]);return ret},this.Raw=function(e,t){return this.Read(e,t,Int8Array)},this.Int=function(e,t){return this.Read(e,t,Int32Array)},this.Short=function(e,t){return this.Read(e,t,Int16Array)},this.Float=function(e,t){return this.Read(e,t,Float32Array)},this.Read=function(e,i,r){i||(i=1);var a=new r(this.buffer,e,i);return 1==i?a[0]:t(a)};var t=function(e){for(var t=[],i=0;i<e.length;i++)t.push(e[i]);return t}}function VTFHeader(e){this.buffer=e,reader=new VTFReader(this.buffer),this.signature=reader.Char(0,4),this.version=reader.Int(4,1)+"."+reader.Int(8,1),this.headerSize=reader.Int(12,1),this.width=reader.Short(16,1),this.height=reader.Short(18,1),this.flags=reader.Int(20,1),this.frames=reader.Int(24,1),this.firstFrame=reader.Short(28,1),this.reflectivity=reader.Float(32,3),this.bumpmapScale=reader.Float(48,1),this.highResImageFormat=reader.Int(52,1)+1,this.mipmapCount=reader.Raw(56,1),this.lowResImageFormat=new Int32Array(reader.Raw(57,4))[0]+1,this.lowResImageWidth=reader.Raw(61,1),this.lowResImageHeight=reader.Raw(62,1),this.depth=new Int16Array(reader.Raw(63,2))[0]}function VTFImage(e,t,r,a,s){this.buffer=s,this.s=e,this.t=t,this.r=r,this.format={format:0,dataType:0,order:[0,1,2]},reader=new VTFReader(this.buffer),this.rawData,this.rgbaData,this.isSupported=!1,this.sizeInBytes=-1,this.hasAlphaChannel=!0,this.__construct=function(){this.s>0&&this.t>0&&(this.isSupported=n(a,this.format),this.isSupported&&this._Import())},this.getSizeInBytes=function(){return-1==this.sizeInBytes&&(this.sizeInBytes=this.s*this.t*this.r*3),this.sizeInBytes};var n=function(e,t){var i=!0;switch(VTF_IMAGE_FORMATS[e]){case"VTF_FORMAT_RGBA8888":t.internalFormat=GL_IMAGE_FORMATS.GL_RGBA,t.order=[0,1,2,3];break;case"VTF_FORMAT_ABGR8888":t.internalFormat=GL_IMAGE_FORMATS.GL_RGBA,t.order=[3,2,1,0];break;case"VTF_FORMAT_RGB888":t.internalFormat=GL_IMAGE_FORMATS.GL_RGB,t.order=[0,1,2];break;case"VTF_FORMAT_BGR888":t.internalFormat=GL_IMAGE_FORMATS.GL_RGB,t.order=[2,1,0];break;case"VTF_FORMAT_ARGB8888":t.internalFormat=GL_IMAGE_FORMATS.GL_RGBA,t.order=[3,0,1,2];break;case"VTF_FORMAT_BGRA8888":t.internalFormat=GL_IMAGE_FORMATS.GL_RGBA,t.order=[2,1,0,3];break;default:i=!1}return t.dataType=Int8Array,i};this._Import=function(){this.rawData=new Uint8Array(reader.Raw(0,this.getSizeInBytes())),3==this.format.order.length&&(this.hasAlphaChannel=!1);var e=new Uint8Array(this.rawData.length/3*4),t=0;for(pixel=0;pixel<this.rawData.length;pixel+=this.format.order.length){for(i=0;i<this.format.order.length;i++)e[t]=this.rawData[pixel+this.format.order[i]],t++;0==this.hasAlphaChannel&&(e[t]=255,t++)}this.rawData=e},this.__construct()}function VTFTexture(e){this.buffer=e,this.header,this.thumbnail,this.image,this.mipmaps=[],this.__construct=function(){this.header=new VTFHeader(this.buffer.slice(0,80)),this.thumbnail=new VTFImage(this.header.lowResImageWidth,this.header.lowResImageHeight,this.header.depth,this.header.lowResImageFormat,this.buffer.slice(this.header.headerSize)),offset=this.header.headerSize,offset+=this.thumbnail.getSizeInBytes(),offset+=this._skipMipmaps(),this.image=new VTFImage(this.header.width,this.header.height,this.header.depth,this.header.highResImageFormat,new Uint8Array(this.buffer).slice(offset+128))},this._skipMipmaps=function(){var e=0,t=this.width,i=this.height,r=this.depth;if(this.header.mipmapCount>1)for(k=1;k<this.header.mipmapCount&&(width||height||depth);k++){0==t&&(t=1),0==i&&(i=1),0==r&&(r=1);var a=VTF_IMAGE_FORMAT_SIZE[VTF_IMAGE_FORMAT[this.header.highResImageFormat]];e+=depth*height*a,this.mipmaps[k-1]=e,t>>=1,i>>=1,r>>=1}return e},this.__construct()}$(document).ready(function(){function e(e,t){switch(e){case"shader":window._renderer.obj.setShader($(t).val().toLowerCase());break;case"basetexture":r(t.id),window._renderer.obj.setDiffuseMap();break;case"alpha":window._renderer.obj.setOpacity(Number($(t).val()));break;case"translucent":window._renderer.obj.setTranslucent($(t).val());break;case"bumpmap":r(t.id),window._renderer.obj.setBumpMap();break;case"envmap":"env_cubemap"==$(t).val()?window._renderer.obj.setCubeMap(window._renderer.cubemapTexture):window._renderer.obj.setCubeMap();break;case"envmaptint":window._renderer.obj.setCubeMapTint($(t).val())}}function r(e){var r=document.getElementById(e),a=r.files[0],s=new FileReader,n=["jpg","jpeg","gif","bmp","png"],h=document.getElementById("image_canvas");window._texture=h;var o=window._texture.getContext("2d");s.onload=function(){var e=(s.result,r.value.substr((~-r.value.lastIndexOf(".")>>>0)+2));if("vtf"==e){t=OpenVTF.fromVTF(s.result),window._texture.width=t.header.width,window._texture.height=t.header.height;var h=o.createImageData(t.header.width,t.header.height);for(i=0;i<t.image.rawData.length;i++)h.data[i]=t.image.rawData[i];o.putImageData(h,0,0)}else if(-1!=n.indexOf(e)){var d=new Image;d.onload=function(){o.drawImage(d,0,0)},d.src=URL.createObjectURL(a)}},s.readAsArrayBuffer(a)}window._renderer=new Renderer(document.getElementById("renderer")),window._renderer.init(),window._renderer.animate(),$(".nav-sidebar > div").click(function(e){$(this).toggleClass("active")}),$("#btn-play").click(function(e){$(e.target).toggleClass("glyphicon-play"),$(e.target).toggleClass("glyphicon-pause"),window._renderer.toggleAnimation()}),$("#vmt-import").click(function(e){$("#vmt-file").click()}),$("#vmt-file").change(function(e){importVMT()}),$("#vmt-export").click(function(e){exportVMT()}),$("[id^=param_]").change(function(t){e(t.target.id.split("_")[1],t.target)})}),Editor=function(e){this.inputContainer=e,this.caret=new Caret(e),this.autoComplete=new AutoCompleter(e,this.caret),this.autoComplete.enableScopeCompletion(),this.generateShaderStructure=function(){var e=this.inputContainer.value,t=e.replace(/["']/g,"").split(/[\s\t\n]/g);(e.match(/{/)||[]).length!=(e.match(/}/)||[]).length||(e.match(/"/)||[]).length%2!=0||(e.match(/'/)||[]).length%2!=0;for(var i,r=new Ika.ArrayIterator(t),a=new MaterialNode;(kv=r.next())!==!1;)""!=kv&&("{"==kv?(i=a,a=new Ika.List,a.setParent(i),i.addChild(a)):"}"==kv?a=a.getParent():(a.key&&a.value&&(a=new MaterialNode,a.setParent(i),i.addChild(a)),a.addData(kv.replace(/["']/g,""))));return i.toArray()}},AutoCompleter=function(e,t){this.container=e,this.caret=t,this.enableScopeCompletion=function(){$(this.container).on("keypress",$.proxy(function(e){var t=['"',"{","(","'"],i=['"',"}",")","'"],r=String.fromCharCode(e.which),a=this.caret.getPosition(),s=t.indexOf(r);if(s>-1){var n=e.currentTarget.value.substring(0,a),h=e.currentTarget.value.substring(a);e.currentTarget.value=n+r+i[s]+h,this.caret.setPosition(a+1),e.preventDefault(),e.stopPropagation()}else s=i.indexOf(r),s>-1&&e.currentTarget.value.substring(a).substring(0,1)==i[s]&&(this.caret.setPosition(a+1),e.preventDefault(),e.stopPropagation())},this))}},Caret=function(e){this.container=e,this.getPosition=function(){var e=0;if(this.container.selectionStart)e=this.container.selectionStart;else if(document.selection){this.container.focus();var t=document.selection.createRange();if(null!=t){var i=this.container.createTextRange(),r=i.duplicate();i.moveToBookmark(t.getBookmark()),r.setEndPoint("EndToStart",i),e=r.text.length}}return e},this.setPosition=function(e){this.setSelectionRange(e,e)},this.setSelectionRange=function(e,t){if(this.container.setSelectionRange)this.container.focus(),this.container.setSelectionRange(e,t);else if(this.container.createTextRange){var i=this.container.createTextRange();i.collapse(!0),i.moveEnd("character",t),i.moveStart("character",e),i.select()}}};var Ika={ArrayIterator:function(e){this.arr=e,this.offset=-1,this.get=function(){return this.arr},this.next=function(){return this.offset++,this.offset>=this.arr.length?!1:this.arr[this.offset]},this.previous=function(){return this.offset--,this.offset<0?!1:this.arr[this.offset]},this.at=function(e,t){return void 0===this.arr[e]?!1:t?(this.offset=e,this.arr[this.offset]):this.arr[e]},this.first=function(){return this.offset=0,this.arr[this.offset]},this.last=function(){return this.offset=this.arr.length-1,this.arr[this.offset]}},List:function(e,t){this.key=e,this.value=t,this.children=[],this.parent,this.addChild=function(e){this.children.push(e)},this.setParent=function(e){this.parent=e},this.getParent=function(){return this.parent},this.addData=function(e){this.key?this.value||(this.value=e):this.key=e},this.toArray=function(){var e={};return e.key=this.key,e.value=this.value,e.children=[],this.children.forEach(function(t){e.children.push(t.toArray())}),e}}};Number.prototype.clamp=function(e,t){return Math.min(Math.max(this,e),t)},Renderer=function(e){this.container=e,this.camera,this.scene,this.sceneCube,this.renderer,this.light,this.textureLoader=new THREE.TextureLoader,this.canvasWidth=document.getElementById("renderer").offsetWidth,this.canvasHeight=document.getElementById("renderer").offsetHeight,this.pointLight,this.skybox,this.cubemapTexture,this.ambientLight,this.obj,this.plane,this.targetRotation=0,this.baseTexture,this.init=function(){this.camera=new THREE.PerspectiveCamera(75,this.canvasWidth/this.canvasHeight,1,5e3),this.camera.position.y=100,this.camera.position.z=200,this.scene=new THREE.Scene,this.sceneCube=new THREE.Scene,this.renderFloor(),this.renderSky(),this.renderLights(),this.obj=new RenderObject,this.scene.add(this.obj.mesh),this.renderer=new THREE.WebGLRenderer({}),this.renderer.setClearColor(7895160),this.renderer.setPixelRatio(this.canvasWidth/this.canvasHeight),this.renderer.setSize(this.canvasWidth,this.canvasHeight),this.renderer.autoClear=!1,this.container.appendChild(this.renderer.domElement),window.addEventListener("resize",$.proxy(function(e){this.canvasWidth=document.getElementById("renderer").offsetWidth,this.canvasHeight=document.getElementById("renderer").offsetHeight,this.camera.aspect=this.canvasWidth/this.canvasHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.canvasWidth,this.canvasHeight)},this),!1)},this.animate=function(){this.obj.update(),requestAnimationFrame($.proxy(this.animate,this)),this.renderFrame()},this.renderFrame=function(){this.renderer.render(this.sceneCube,this.camera),this.renderer.render(this.scene,this.camera)},this.toggleAnimation=function(){this.obj.frozen=!this.obj.frozen},this.renderFloor=function(){var e=new THREE.GridHelper(800,64);e.setColors(16777215,16777215),this.scene.add(e)},this.renderSky=function(){var e=["assets/img/sky/skybox_ft.jpg","assets/img/sky/skybox_bk.jpg","assets/img/sky/skybox_up.jpg","assets/img/sky/skybox_dn.jpg","assets/img/sky/skybox_rt.jpg","assets/img/sky/skybox_lf.jpg"];this.cubemapTexture=(new THREE.CubeTextureLoader).load(e),this.cubemapTexture.format=THREE.RGBFormat;var t=THREE.ShaderLib.cube;t.uniforms.tCube.value=this.cubemapTexture;var i=new THREE.ShaderMaterial({fragmentShader:t.fragmentShader,vertexShader:t.vertexShader,uniforms:t.uniforms,depthWrite:!1,side:THREE.BackSide});this.skybox=new THREE.Mesh(new THREE.CubeGeometry(600,600,600),i),this.skybox.flipSided=!0,this.sceneCube.add(this.skybox)},this.renderLights=function(){this.ambientLight=new THREE.AmbientLight(16777215),this.scene.add(this.ambientLight),this.pointLight=new THREE.PointLight(16777215,2),this.scene.add(this.pointLight);var e=new THREE.SphereGeometry(100,16,8),t=new THREE.Mesh(e,new THREE.MeshBasicMaterial({color:16755200}));t.scale.set(.05,.05,.05),this.pointLight.add(t)}},RenderObject=function(){this.geometry,this.mesh,this.material,this.frozen=!0,this.diffuseMap=-1,this.bumpMap=-1,this.specularMap=-1,this.phongMap=-1,this.cubeMap,this.opacity=1,this.translucent=0,this.init=function(){this.geometry=new THREE.BoxGeometry(100,100,100),this.material=new THREE.MeshBasicMaterial({color:16777215,overdraw:.5}),this.mesh=new THREE.Mesh(this.geometry,this.material),this.mesh.position.y=100,this.mesh.dynamic=!0},this.init(),this.update=function(){this.frozen||(this.mesh.rotation.x+=.02,this.mesh.rotation.y+=.01)},this.setMaterial=function(e){},this.setShader=function(e){"unlitgeneric"==e?(this.material=new THREE.MeshBasicMaterial,this.mesh.material=this.material):"vertexlitgeneric"==e||"lightmappedgeneric"==e?(this.material=new THREE.MeshLambertMaterial,this.mesh.material=this.material):alert("VMTEasy does not support the specified shader: "+e)},this.setDiffuseMap=function(){this.mesh.material.map=this._loadTexture(this.diffuseMap),this.diffuseMap=this.mesh.material.map,this._markForUpdate(this.diffuseMap)},this.setBumpMap=function(){this.mesh.material.bumpMap=this._loadTexture(this.bumpMap),this.bumpMap=this.mesh.material.bumpMap,this._markForUpdate(this.bumpMap)},this.setSpecularMap=function(){this.mesh.material.specularMap=this._loadTexture(this.normalMap),this.specularMap=this.mesh.material.specularMap,this._markForUpdate(this.specularMap)},this.setPhongMap=function(){this.mesh.material.phongMap=this._loadTexture(this.phongMap),this.phongMap=this.mesh.material.phongMap,this._markForUpdate(this.phongMap)},this.setOpacity=function(e){1>e?this.mesh.material.transparent=!0:this.mesh.material.transparent=!1,this.opacity==e,this.mesh.material.opacity=e,this._markForUpdate(this.diffuseMap)},this.setTranslucent=function(e){"1"==e&&(this.mesh.material.transparent=!0,this.translucent=!0),this._markForUpdate(this.diffuseMap)},this.setCubeMap=function(e){e?(this.cubemapTexture=e,this.mesh.material.envMap=this.cubemapTexture):(this.cubemapTexture=null,this.mesh.material.envMap=null),this.mesh.material.needsUpdate=!0},this._loadTexture=function(){return new THREE.Texture(document.getElementById("image_canvas"))},this._markForUpdate=function(e){e.needsUpdate=!0,this.mesh.material.needsUpdate=!0}},exportVMT=function(){function e(e){for(indents="";e>0;)indents+="	",e-=1;return indents}function t(i,r,a){return i.children.length>0?(r+=e(a-1),r+='"'+i.value+'"\n',r+=e(a-1),r+="{\n",++a,i.children.forEach(function(e){r=t(e,r,a)}),r+=e(a-1),r+="}\n"):""!=i.value&&"-1"!=i.value&&(r+=e(a),r+='"'+i.key+'"	"'+i.value+'"\n'),r}var i,r,a;$("[id^=param_]").each(function(e,t){var s=$(t);a=new Ika.List(s.prev().text(),s.val()),r?(a.setParent(r),r.addChild(a)):(r=a,i=r)}),response=t(i,"",0);var s=$("#output-filename").val();s?-1===s.indexOf(".vmt")&&(s+=".vmt"):s="vmteasy.vmt",saveToClient(s,response)},importVMT=function(){},saveToClient=function(e,t){var i=new Blob([t],{type:"text/palin"});if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveBlob(i,e);else{var r=window.document.createElement("a");r.href=window.URL.createObjectURL(i),r.download=e,document.body.appendChild(r),r.click(),document.body.removeChild(r)}},VTF_IMAGE_FORMATS={0:"VTF_FORMAT_NONE",1:"VTF_FORMAT_RGBA8888",2:"VTF_FORMAT_ABGR8888",3:"VTF_FORMAT_RGB888",4:"VTF_FORMAT_BGR888",5:"VTF_FORMAT_RGB565",6:"VTF_FORMAT_I8",7:"VTF_FORMAT_IA88",8:"VTF_FORMAT_P8",9:"VTF_FORMAT_A8",10:"VTF_FORMAT_RGB888_BLUESCREEN",11:"VTF_FORMAT_BGR888_BLUESCREEN",12:"VTF_FORMAT_ARGB8888",13:"VTF_FORMAT_BGRA8888",14:"VTF_FORMAT_DXT1",15:"VTF_FORMAT_DXT3",16:"VTF_FORMAT_DXT5",17:"VTF_FORMAT_BGRX8888",18:"VTF_FORMAT_BGR565",19:"VTF_FORMAT_BGRX5551",20:"VTF_FORMAT_BGRA4444",21:"VTF_FORMAT_DXT1_ONEBITALPHA",22:"VTF_FORMAT_BGRA5551",23:"VTF_FORMAT_UV88",24:"VTF_FORMAT_UVWQ8888",25:"VTF_FORMAT_RGBA16161616F",26:"VTF_FORMAT_RGBA16161616",27:"VTF_FORMAT_UVLX8888"},VTF_IMAGE_FORMAT_SIZE={VTF_FORMAT_RGBA8888:4,VTF_FORMAT_ABGR8888:4,VTF_FORMAT_RGB888:3,VTF_FORMAT_BGR888:3,VTF_FORMAT_RGB565:3,VTF_FORMAT_ARGB8888:4,VTF_FORMAT_BGRA8888:4,VTF_FORMAT_DXT1:3,VTF_FORMAT_DXT3:3,VTF_FORMAT_DXT5:3,VTF_FORMAT_BGR565:3},GL_IMAGE_FORMATS={GL_RGB:3,GL_RGBA:4,GL_BGR:3,GL_BGRA:4,GL_RGBA:4},OpenVTF={fromVTF:function(e){return new VTFTexture(e)}};